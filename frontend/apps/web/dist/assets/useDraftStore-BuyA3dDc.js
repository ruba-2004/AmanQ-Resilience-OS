const h=(e,t)=>t.some(n=>e instanceof n);let B,g;function C(){return B||(B=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function x(){return g||(g=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const b=new WeakMap,w=new WeakMap,l=new WeakMap;function S(e){const t=new Promise((n,r)=>{const s=()=>{e.removeEventListener("success",i),e.removeEventListener("error",o)},i=()=>{n(d(e.result)),s()},o=()=>{r(e.error),s()};e.addEventListener("success",i),e.addEventListener("error",o)});return l.set(t,e),t}function j(e){if(b.has(e))return;const t=new Promise((n,r)=>{const s=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",o),e.removeEventListener("abort",o)},i=()=>{n(),s()},o=()=>{r(e.error||new DOMException("AbortError","AbortError")),s()};e.addEventListener("complete",i),e.addEventListener("error",o),e.addEventListener("abort",o)});b.set(e,t)}let D={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return b.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return d(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function L(e){D=e(D)}function O(e){return x().includes(e)?function(...t){return e.apply(I(this),t),d(this.request)}:function(...t){return d(e.apply(I(this),t))}}function p(e){return typeof e=="function"?O(e):(e instanceof IDBTransaction&&j(e),h(e,C())?new Proxy(e,D):e)}function d(e){if(e instanceof IDBRequest)return S(e);if(w.has(e))return w.get(e);const t=p(e);return t!==e&&(w.set(e,t),l.set(t,e)),t}const I=e=>l.get(e);function v(e,t,{blocked:n,upgrade:r,blocking:s,terminated:i}={}){const o=indexedDB.open(e,t),f=d(o);return r&&o.addEventListener("upgradeneeded",a=>{r(d(o.result),a.oldVersion,a.newVersion,d(o.transaction),a)}),n&&o.addEventListener("blocked",a=>n(a.oldVersion,a.newVersion,a)),f.then(a=>{i&&a.addEventListener("close",()=>i()),s&&a.addEventListener("versionchange",u=>s(u.oldVersion,u.newVersion,u))}).catch(()=>{}),f}const T=["get","getKey","getAll","getAllKeys","count"],V=["put","add","delete","clear"],y=new Map;function P(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(y.get(t))return y.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,s=V.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(s||T.includes(n)))return;const i=async function(o,...f){const a=this.transaction(o,s?"readwrite":"readonly");let u=a.store;return r&&(u=u.index(f.shift())),(await Promise.all([u[n](...f),s&&a.done]))[0]};return y.set(t,i),i}L(e=>({...e,get:(t,n,r)=>P(t,n)||e.get(t,n,r),has:(t,n)=>!!P(t,n)||e.has(t,n)}));const F=["continue","continuePrimaryKey","advance"],E={},m=new WeakMap,A=new WeakMap,k={get(e,t){if(!F.includes(t))return e[t];let n=E[t];return n||(n=E[t]=function(...r){m.set(this,A.get(this)[t](...r))}),n}};async function*W(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,k);for(A.set(n,t),l.set(n,I(t));t;)yield n,t=await(m.get(n)||t.continue()),m.delete(n)}function M(e,t){return t===Symbol.asyncIterator&&h(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&h(e,[IDBIndex,IDBObjectStore])}L(e=>({...e,get(t,n,r){return M(t,n)?W:e.get(t,n,r)},has(t,n){return M(t,n)||e.has(t,n)}}));const c=v("amanq-drafts",1,{upgrade(e){e.createObjectStore("drafts",{keyPath:"fileId"}),e.createObjectStore("queue",{keyPath:"createdAt"})}});async function q(e){return await(await c).get("drafts",e)}async function K(){return await(await c).getAll("drafts")}async function N(e){await(await c).put("drafts",e)}async function R(e){await(await c).delete("drafts",e)}async function Q(e){await(await c).put("queue",e)}async function $(e){const t=await c,n=await t.getAll("queue"),r=t.transaction("queue","readwrite");n.filter(s=>s.fileId===e).forEach(s=>{r.store.delete(s.createdAt)}),await r.done}async function z(){await(await c).clear("queue")}async function G(){await(await c).clear("drafts")}export{K as a,G as b,$ as c,R as d,Q as e,z as f,q as g,N as s};
