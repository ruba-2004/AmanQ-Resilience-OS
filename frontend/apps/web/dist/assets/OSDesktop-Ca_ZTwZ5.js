import{r as i,j as n,a as R,p as E,n as G,b as Q}from"./index-C-92nb6o.js";import{g as Z,d as B,c as K,e as se,s as te,a as I}from"./useDraftStore-BuyA3dDc.js";import{D as ie}from"./DashboardContent-BcQ3yWen.js";function ae({onOpenFile:e,embedded:p,serverId:a}){const[s,v]=i.useState([]),[t,N]=i.useState([]),[m,S]=i.useState("root"),[h,k]=i.useState([{id:"root",name:"Home"}]),[y,l]=i.useState(null),[u,b]=i.useState(""),j=a?G(a):R,g=async(r=m)=>{try{const D=await j.listFolder(r);v(D.files||[]),N(D.folders||[])}catch{E("Unable to load file list")}};i.useEffect(()=>{g()},[m,a]);const F=i.useMemo(()=>h.map(r=>r.name).join(" / "),[h]),z=async()=>{const r=u.trim();if(r)try{await j.createFolder(m,r),E(`Folder created: ${r}`),g(m),l(null),b("")}catch{E("Folder create failed")}},T=async()=>{const r=u.trim();if(r)try{await j.createFile(m,r,"txt"),E(`File created: ${r}.txt`),g(m),l(null),b("")}catch{E("File create failed")}},C=r=>{S(r.id),k(D=>[...D,{id:r.id,name:r.name}])},L=()=>{if(h.length<=1)return;const r=h.slice(0,-1),D=r[r.length-1];k(r),S(D.id)};return n.jsxs("div",{className:p?"os-window-inner file-list":"window file-list",children:[n.jsxs("div",{className:"window-header",children:[n.jsxs("div",{className:"window-title",children:[n.jsx("span",{children:"ðŸ“"}),n.jsx("span",{children:"File Explorer"})]}),n.jsxs("div",{className:"toolbar",children:[n.jsx("button",{onClick:L,disabled:h.length<=1,children:"Up"}),n.jsx("button",{onClick:()=>l("folder"),children:"New folder"}),n.jsx("button",{className:"primary",onClick:()=>l("file"),children:"New file"}),n.jsx("button",{onClick:()=>g(m),children:"Refresh"})]})]}),n.jsxs("div",{className:"path-bar",children:["Path: ",F]}),n.jsxs("div",{style:{opacity:.7,marginBottom:8,fontSize:12},children:[t.length," folders Â· ",s.length," files"]}),n.jsxs("div",{children:[n.jsx("strong",{children:"Folders"}),t.length===0&&n.jsx("div",{style:{opacity:.7,fontSize:12,marginTop:6},children:"No folders yet."}),t.map(r=>n.jsxs("div",{className:"file-row",onClick:()=>C(r),children:["ðŸ“ ",r.name]},r.id))]}),n.jsxs("div",{style:{marginTop:12},children:[n.jsx("strong",{children:"Files"}),s.length===0&&n.jsx("div",{style:{opacity:.7,fontSize:12,marginTop:6},children:"No files yet."}),s.map(r=>n.jsxs("div",{className:"file-row",onClick:()=>e(r),children:[n.jsxs("span",{className:"file-name",children:[n.jsx("span",{className:"file-icon",children:"ðŸ“„"}),r.name,".",r.ext]}),n.jsxs("span",{style:{opacity:.6,fontSize:12},children:["v",r.serverVersion]})]},r.id))]}),y&&n.jsx("div",{className:"modal",children:n.jsxs("div",{className:"modal-card",children:[n.jsx("h3",{children:y==="folder"?"Create folder":"Create file"}),n.jsx("p",{style:{opacity:.7},children:y==="folder"?"Choose a name for your new folder.":"Choose a file name (extension will be .txt)."}),n.jsx("input",{className:"input",autoFocus:!0,placeholder:y==="folder"?"Folder name":"File name",value:u,onChange:r=>b(r.target.value),onKeyDown:r=>{r.key==="Enter"&&(y==="folder"?z():T()),r.key==="Escape"&&(l(null),b(""))}}),n.jsxs("div",{className:"modal-actions",children:[n.jsx("button",{className:"primary",onClick:y==="folder"?z:T,children:"Create"}),n.jsx("button",{onClick:()=>{l(null),b("")},children:"Cancel"})]})]})})]})}function oe({fileId:e,fileName:p,embedded:a,serverId:s}){const[v,t]=i.useState(""),[N,m]=i.useState("Idle"),[S,h]=i.useState(0),[k,y]=i.useState(0),[l,u]=i.useState(null),[b,j]=i.useState(null),[g,F]=i.useState(null),[z,T]=i.useState(null),[C,L]=i.useState(null),$=i.useRef(0),r=i.useRef(null),D=i.useRef(null),O=i.useRef(!1),V=i.useRef(()=>{}),U=i.useRef(()=>{}),H=i.useRef(null),A=i.useRef(null);H.current=l;const Y=i.useCallback(async()=>{var o,f;if(e)try{let d="",P=0;if(s){const J=await G(s).openFile(e);d=J.content||"",F(null),T(s),L(null),t(d),h(J.serverVersion||0),y(0),m("Saved"),j(Date.now())}else{const M=await R.openSession("demo",e);d=M.content||"",P=M.serverVersion||0,F(M.sessionId),T(M.targetNode),L(`${((o=M.snapshotPolicy)==null?void 0:o.everySeconds)||0}s / ${((f=M.snapshotPolicy)==null?void 0:f.everyEvents)||0} events`),t(d),h(M.serverVersion||0),y(0),m("Saved"),j(Date.now())}const W=await Z(e);if(W&&W.content!==d)u(W);else if(s)u(null);else{u(null);try{const M=await R.recoveryFileStates(e);Array.isArray(M)&&M.length>0&&u({fileId:e,content:"",baseServerVersion:P,localVersion:0,lastEditAt:0,context:"workspace"})}catch{}}}catch{if(F(null),T(null),L(null),s){m("Queued"),E("Failed to open file from this server. Using local draft if available.");const d=await Z(e);d&&(t(d.content),h(d.baseServerVersion),y(d.localVersion))}else try{const d=await R.openFile(e);t(d.content||""),h(d.serverVersion||0),y(0),m("Saved"),j(Date.now())}catch{m("Queued"),E("Failed to open file, using local draft if available");const d=await Z(e);d&&(t(d.content),h(d.baseServerVersion),y(d.localVersion))}}},[e,s]);i.useEffect(()=>{Y()},[Y]);const X=o=>{if(!e)return;t(o);const f=k+1;y(f),m("Unsaved"),$.current=Date.now(),r.current&&window.clearTimeout(r.current),r.current=window.setTimeout(()=>{const d={fileId:e,content:o,lastEditAt:$.current,localVersion:f,baseServerVersion:S,context:s??"workspace"};te(d).catch(()=>null)},300),D.current&&window.clearTimeout(D.current),D.current=window.setTimeout(()=>{g&&!s&&R.sendDraftEvent(e,{sessionId:g,op:"set",data:{content:o},ts:Date.now()}).catch(()=>null)},400)},q=i.useCallback(async(o=!1)=>{if(!(!e||O.current||N==="Saved")){O.current=!0;try{if(s){const d=await G(s).saveFile(e,{content:v,baseServerVersion:S});h(d.serverVersion),m("Saved"),j(Date.now()),await B(e),await K(e),o&&E(`Saved on ${s}`)}else if(g){const f=await R.saveFinal(e,{sessionId:g});h(f.serverVersion),m("Saved"),j(Date.now()),await B(e),await K(e),o&&E(`Saved on ${f.savedOn||z||"node"}`)}else{const f=await R.saveFile(e,{content:v,baseServerVersion:S,clientLocalVersion:k});f.status===409?(t(f.data.latestContent),h(f.data.serverVersion),y(0),m("Saved"),j(Date.now()),await B(e),await K(e),o&&E("Conflict resolved with server version")):(h(f.data.serverVersion),m("Saved"),j(Date.now()),await B(e),await K(e))}}catch{await se({fileId:e,content:v,baseServerVersion:S,clientLocalVersion:k,createdAt:Date.now()}),m("Queued")}finally{O.current=!1}}},[S,v,e,k,N,g,z,s]),c=i.useCallback(async o=>{const f=H.current;if(!f)return;const d=o??f.content;t(d),h(f.baseServerVersion),y(f.localVersion),m("Unsaved"),u(null)},[]),w=i.useCallback(async()=>{e&&await B(e),u(null)},[e]);return V.current=c,U.current=w,i.useEffect(()=>{if(!l||!e)return;const o=`${e}-${l.lastEditAt}`;if(A.current===o)return;A.current=o;const f=l.content.length>0?l.content.slice(0,200)+(l.content.length>200?"â€¦":""):"The server has unsaved data for this file. Restore a version?",d=()=>{Q({title:"Unsaved session detected. Restore?",message:f,actions:[{label:"Recover",onClick:()=>{A.current=null,(async()=>{if(e)try{const W=await R.recoveryRestore(e);(W==null?void 0:W.content)!=null?V.current(W.content):V.current()}catch{V.current()}else V.current()})()}},{label:"Discard",onClick:()=>{A.current=null,U.current()}}]})},P=window.setTimeout(d,250);return()=>window.clearTimeout(P)},[l,e]),n.jsxs("div",{className:a?"os-window-inner":"window",children:[n.jsxs("div",{className:"window-header",children:[n.jsxs("div",{className:"window-title",children:[n.jsx("span",{children:"ðŸ“"}),n.jsx("span",{children:p||"No file selected"})]}),n.jsxs("div",{className:"toolbar",children:[n.jsx("span",{className:`status-pill ${N==="Saved"?"saved":N==="Queued"?"queued":N==="Unsaved"?"unsaved":""}`,children:N}),n.jsx("button",{className:"primary",onClick:()=>q(!0),disabled:!e||N==="Saved",children:"Save now"})]})]}),n.jsxs("div",{style:{display:"flex",gap:16,marginBottom:8,opacity:.7},children:[n.jsxs("span",{children:["Server v",S]}),n.jsxs("span",{children:["Local v",k]}),z&&n.jsxs("span",{children:["Node ",z]}),C&&n.jsxs("span",{children:["Snapshot ",C]}),n.jsx("span",{children:b?`Last saved ${new Date(b).toLocaleTimeString()}`:"Not saved yet"})]}),n.jsx("textarea",{className:"editor",value:v,onChange:o=>X(o.target.value),placeholder:e?"Start typing...":"Select a file to begin editing.",readOnly:!e})]})}const ee=[{id:"explorer",label:"File Explorer",icon:"ðŸ“"},{id:"editor",label:"Editor",icon:"ðŸ“"},{id:"controller",label:"Controller",icon:"ðŸ§­"},{id:"server1",label:"Server S1",icon:"ðŸ–¥ï¸"},{id:"server2",label:"Server S2",icon:"ðŸ–¥ï¸"},{id:"dashboard",label:"Dashboard",icon:"ðŸ“Š"}];function re({onOpen:e,visibleIds:p}){const a=p?ee.filter(s=>p.includes(s.id)):ee;return n.jsx("div",{className:"desktop-icon-grid",children:a.map(s=>n.jsxs("button",{className:"desktop-icon",onClick:()=>e(s.id),children:[n.jsx("div",{className:"desktop-icon-emoji",children:s.icon}),n.jsx("div",{className:"desktop-icon-label",children:s.label})]},s.id))})}function le({windows:e,onSelect:p,controllerState:a}){const[s,v]=i.useState(new Date);return i.useEffect(()=>{const t=window.setInterval(()=>v(new Date),1e3);return()=>window.clearInterval(t)},[]),n.jsxs("div",{className:"taskbar-dock",children:[n.jsxs("button",{className:"taskbar-start",children:[n.jsx("span",{className:"taskbar-icon",children:"ðŸªŸ"}),"Start"]}),n.jsx("div",{className:"taskbar-windows",children:e.filter(t=>t.isOpen).map(t=>n.jsxs("button",{className:`taskbar-btn ${t.isOpen&&!t.isMinimized?"active":""}`,onClick:()=>p(t.id),children:[n.jsx("span",{className:"taskbar-icon",children:t.icon}),t.title]},t.id))}),n.jsx("div",{className:"taskbar-status",children:((a==null?void 0:a.servers)||[]).map(t=>n.jsxs("span",{className:`status-chip ${t.status==="UP"?"ok":"down"}`,children:[t.id,": ",t.status]},t.id))}),n.jsx("div",{className:"taskbar-clock",children:s.toLocaleTimeString()})]})}function ce({item:e,onUpdate:p,onFocus:a,onMinimize:s,onClose:v}){const t=i.useRef(null),N=()=>{t.current=null,window.removeEventListener("pointermove",m),window.removeEventListener("pointerup",S)},m=l=>{const u=t.current;if(u)if(u.type==="move"){const b=u.originX+(l.clientX-u.startX),j=u.originY+(l.clientY-u.startY),g=window.innerWidth-100,F=window.innerHeight-80;p(e.id,{x:Math.max(0,Math.min(b,g)),y:Math.max(0,Math.min(j,F))})}else{const b=u.originW+(l.clientX-u.startX),j=u.originH+(l.clientY-u.startY);p(e.id,{w:Math.max(e.minW,b),h:Math.max(e.minH,j)})}},S=()=>{N()},h=l=>{l.preventDefault(),a(e.id),!e.isMaximized&&(t.current={type:"move",startX:l.clientX,startY:l.clientY,originX:e.x,originY:e.y,originW:e.w,originH:e.h},window.addEventListener("pointermove",m),window.addEventListener("pointerup",S))},k=l=>{l.preventDefault(),a(e.id),!e.isMaximized&&(t.current={type:"resize",startX:l.clientX,startY:l.clientY,originX:e.x,originY:e.y,originW:e.w,originH:e.h},window.addEventListener("pointermove",m),window.addEventListener("pointerup",S))};if(!e.isOpen||e.isMinimized)return null;const y=()=>{if(e.isMaximized&&e.restoreBounds){p(e.id,{...e.restoreBounds,isMaximized:!1});return}const l=16,u=72;p(e.id,{restoreBounds:{x:e.x,y:e.y,w:e.w,h:e.h},x:l,y:u,w:window.innerWidth-l*2,h:window.innerHeight-u-88,isMaximized:!0})};return n.jsxs("div",{className:`os-window ${e.isMaximized?"maximized":""}`,style:{left:e.x,top:e.y,width:e.w,height:e.h,zIndex:e.z},onPointerDown:()=>a(e.id),children:[n.jsxs("div",{className:"os-window-titlebar",onPointerDown:h,children:[n.jsxs("div",{className:"os-window-title",children:[n.jsx("span",{children:e.icon}),n.jsx("span",{children:e.title})]}),n.jsxs("div",{className:"os-window-actions",children:[n.jsx("button",{className:"win-btn min",onClick:()=>s(e.id),children:"â€”"}),n.jsx("button",{className:"win-btn max",onClick:y,children:"â–¢"}),n.jsx("button",{className:"win-btn close",onClick:()=>v(e.id),children:"Ã—"})]})]}),n.jsx("div",{className:"os-window-content",children:e.content}),n.jsx("div",{className:"os-window-resize",onPointerDown:k})]})}function de({windows:e,onUpdate:p,onFocus:a,onMinimize:s,onClose:v}){return n.jsx("div",{className:"desktop-canvas",children:e.sort((t,N)=>t.z-N.z).map(t=>n.jsx(ce,{item:t,onUpdate:p,onFocus:a,onMinimize:s,onClose:v},t.id))})}function ue({state:e}){var a;const p=(e==null?void 0:e.trafficShare)||[];return n.jsxs("div",{className:"panel os-console",children:[n.jsx("h4",{children:"Controller Status"}),n.jsxs("p",{children:["Mode: ",(e==null?void 0:e.mode)||"baseline"]}),n.jsxs("p",{children:["Avg Latency: ",(e==null?void 0:e.avgLatencyMs)??0," ms"]}),n.jsxs("p",{children:["Total RPS: ",(e==null?void 0:e.totalRps)??0]}),n.jsxs("p",{children:["Backup: ",((a=e==null?void 0:e.backup)==null?void 0:a.status)||"idle"]}),n.jsxs("div",{style:{marginTop:10},children:[n.jsx("strong",{children:"Traffic Share"}),p.map(s=>n.jsxs("div",{style:{marginTop:6},children:[n.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[n.jsx("span",{children:s.serverId}),n.jsxs("span",{children:[s.pct,"%"]})]}),n.jsx("div",{className:"chart-bar",children:n.jsx("span",{style:{width:`${s.pct}%`}})})]},s.serverId))]})]})}function ne({serverId:e,state:p}){const a=((p==null?void 0:p.servers)||[]).find(s=>s.id===e);return n.jsxs("div",{className:"panel os-console",children:[n.jsxs("h4",{children:[e," Status"]}),n.jsxs("p",{children:["Status: ",(a==null?void 0:a.status)||"DOWN"]}),n.jsxs("p",{children:["CPU: ",(a==null?void 0:a.cpu)??0,"%"]}),n.jsxs("p",{children:["RAM: ",(a==null?void 0:a.ram)??0,"%"]}),n.jsxs("p",{children:["Latency: ",(a==null?void 0:a.latencyMs)??0," ms"]}),n.jsxs("p",{children:["Last Seen: ",(a==null?void 0:a.lastSeenSec)??0,"s"]})]})}function he(){return n.jsx("div",{className:"dashboard-window",children:n.jsx(ie,{})})}const me="amanq-server-down-dismissed";function _(e){return`${me}-${e}`}const fe=[{id:"explorer",title:"File Explorer",icon:"ðŸ“",content:null,x:80,y:140,w:360,h:420,minW:280,minH:260,z:1,isOpen:!0,isMinimized:!1,isMaximized:!1,restoreBounds:null},{id:"editor",title:"Document Editor",icon:"ðŸ“",content:null,x:480,y:160,w:520,h:420,minW:360,minH:300,z:2,isOpen:!0,isMinimized:!1,isMaximized:!1,restoreBounds:null},{id:"controller",title:"Controller Console",icon:"ðŸ§­",content:null,x:120,y:580,w:360,h:260,minW:300,minH:220,z:3,isOpen:!0,isMinimized:!1,isMaximized:!1,restoreBounds:null},{id:"server1",title:"S1 Console",icon:"ðŸ–¥ï¸",content:null,x:520,y:600,w:280,h:240,minW:260,minH:220,z:4,isOpen:!0,isMinimized:!1,isMaximized:!1,restoreBounds:null},{id:"server2",title:"S2 Console",icon:"ðŸ–¥ï¸",content:null,x:820,y:600,w:280,h:240,minW:260,minH:220,z:5,isOpen:!0,isMinimized:!1,isMaximized:!1,restoreBounds:null},{id:"dashboard",title:"Monitoring Dashboard",icon:"ðŸ“Š",content:null,x:1080,y:160,w:520,h:520,minW:420,minH:360,z:6,isOpen:!1,isMinimized:!1,isMaximized:!1,restoreBounds:null}];function pe(e,p){const a=e?new Set(e):null,s=fe.map((v,t)=>({...v,isOpen:a?a.has(v.id):v.isOpen,isMinimized:!1,isMaximized:!1,restoreBounds:null,z:t+1}));if(p){const v=Math.max(...s.map(t=>t.z));return s.map(t=>t.id===p?{...t,z:v+1,isOpen:!0}:t)}return s}function Se({initialOpenIds:e,initialFocusId:p,visibleWindowIds:a,serverContext:s,initialDataLost:v}){const[t,N]=i.useState(null),[m,S]=i.useState(pe(e,p)),[h,k]=i.useState(null),[y,l]=i.useState(!1),u=(h==null?void 0:h.servers)||[],b=h!=null&&Array.isArray(u)&&u.length>0,j=c=>String(c||"").trim().toUpperCase(),g=s&&b&&u.some(c=>j(c.id)===j(s)&&String(c.status||"").toUpperCase()==="DOWN"),F=s&&b&&u.some(c=>j(c.id)===j(s)&&String(c.status||"").toUpperCase()==="UP"),z=s&&g&&(()=>{try{return sessionStorage.getItem(_(s))==="1"}catch{return!1}})();i.useEffect(()=>{!s||!g||z&&l(!0)},[s,g,z]);const T=!!s&&g&&!y&&!z;i.useEffect(()=>{if(!(!s||!b)&&F){try{sessionStorage.removeItem(_(s))}catch{}l(!1)}},[s,b,F]);const C=i.useCallback(()=>{I().then(c=>{const x=c.filter(o=>o.context===s||o.context==null&&s).sort((o,f)=>f.lastEditAt-o.lastEditAt)[0];x&&(N({id:x.fileId,name:x.fileId,ext:"txt"}),S(o=>{const f=Math.max(...o.map(d=>d.z));return o.map(d=>d.id==="editor"?{...d,z:f+1,isMinimized:!1,isOpen:!0}:d)}))})},[s]),L=i.useCallback(async()=>{if(!s)return;try{await R.restoreServer(s);try{const o=await R.getState();k(o)}catch{}}catch{}try{sessionStorage.setItem(_(s),"1")}catch{}l(!0);const w=(await I()).filter(o=>o.context===s||o.context==null&&s),x=()=>{w.length>0?Q({title:"Recovery",message:"You have unsaved work. Recover your data?",actions:[{label:"Recover",onClick:C},{label:"Dismiss",onClick:()=>{}}]}):Q({title:"Server restarted",message:`Server ${s} is back online.`,actions:[{label:"OK",onClick:()=>{}}]})};window.setTimeout(x,400)},[s,C]),$=i.useRef(!1);i.useEffect(()=>{if(!v||!s||$.current)return;$.current=!0;const c=s==="S1"?"S1":"S2",w=()=>{Q({title:"Notification",message:`Your data on server ${c} has been wiped. Recover your work from drafts?`,actions:[{label:"Recover",onClick:C},{label:"Dismiss",onClick:()=>{}}]})},x=window.setTimeout(w,300);return()=>window.clearTimeout(x)},[v,s,C]),i.useEffect(()=>{let c=!0;const w=async()=>{try{const f=await R.getState();c&&k(f)}catch{}};w();const x=s?1500:3e3,o=window.setInterval(w,x);return()=>{c=!1,window.clearInterval(o)}},[s]);const r=i.useMemo(()=>({explorer:n.jsx(ae,{onOpenFile:N,embedded:!0,serverId:s}),editor:n.jsx(oe,{fileId:t==null?void 0:t.id,fileName:t?`${t.name}.${t.ext}`:void 0,embedded:!0,serverId:s}),controller:n.jsx(ue,{state:h}),server1:n.jsx(ne,{serverId:"S1",state:h}),server2:n.jsx(ne,{serverId:"S2",state:h}),dashboard:n.jsx(he,{})}),[t,h,s]),D=c=>c.map(w=>({...w,content:r[w.id]})),O=i.useMemo(()=>a?new Set(a):null,[a]),V=c=>{S(w=>{const x=Math.max(...w.map(o=>o.z));return w.map(o=>o.id===c?{...o,z:x+1,isMinimized:!1,isOpen:!0}:o)})},U=(c,w)=>{S(x=>x.map(o=>o.id===c?{...o,...w}:o))},H=c=>{S(w=>w.map(x=>x.id===c?{...x,isMinimized:!x.isMinimized}:x))},A=c=>{S(w=>w.map(x=>x.id===c?{...x,isOpen:!1}:x))},Y=c=>{V(c)};i.useEffect(()=>{O&&S(c=>c.map(w=>O.has(w.id)?w:{...w,isOpen:!1,isMinimized:!0}))},[O]);const X=O?m.filter(c=>O.has(c.id)):m,q=s==="S1"?"S1":"S2";return n.jsxs("div",{className:"desktop-shell",children:[n.jsx(re,{onOpen:Y,visibleIds:a}),n.jsx(de,{windows:D(X),onFocus:V,onUpdate:U,onMinimize:H,onClose:A}),n.jsx(le,{windows:X,onSelect:Y,controllerState:h}),T&&n.jsx("div",{className:"server-down-overlay",children:n.jsxs("div",{className:"server-down-overlay-inner",children:[n.jsxs("p",{className:"server-down-title",children:["Server ",q," is shut down"]}),n.jsx("p",{className:"server-down-sub",children:"The device is off. Re-open to continue."}),n.jsx("button",{type:"button",className:"server-down-btn primary",onClick:L,children:"Re-open device"})]})})]})}export{Se as O};
